<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sem.database &#8212; sem 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for sem.database</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">and_</span><span class="p">,</span> <span class="n">or_</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
<span class="kn">from</span> <span class="nn">tinydb</span> <span class="kn">import</span> <span class="n">TinyDB</span><span class="p">,</span> <span class="n">where</span>
<span class="kn">from</span> <span class="nn">tinydb.storages</span> <span class="kn">import</span> <span class="n">JSONStorage</span>
<span class="kn">from</span> <span class="nn">tinydb.middlewares</span> <span class="kn">import</span> <span class="n">CachingMiddleware</span>

<span class="n">REUSE_RNGRUN_VALUES</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="DatabaseManager"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager">[docs]</a><span class="k">class</span> <span class="nc">DatabaseManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This serves as an interface with the simulation campaign database.</span>

<span class="sd">    A database can either be created from scratch or loaded, via the new and</span>
<span class="sd">    load @classmethods.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">##################</span>
    <span class="c1"># Initialization #</span>
    <span class="c1">##################</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">campaign_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the DatabaseManager with a TinyDB instance.</span>

<span class="sd">        This function assumes that the DB is already complete with a config</span>
<span class="sd">        entry, as created by the new and load classmethods, and should not be</span>
<span class="sd">        called directly. Use the CampaignManager.new() and</span>
<span class="sd">        CampaignManager.load() facilities instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">campaign_dir</span> <span class="o">=</span> <span class="n">campaign_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>

<div class="viewcode-block" id="DatabaseManager.new"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.new">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">campaign_dir</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a new class instance with a set configuration and filename.</span>

<span class="sd">        The created database has the same name of the campaign directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            script (str): the ns-3 name of the script that will be used in this</span>
<span class="sd">                campaign;</span>
<span class="sd">            commit (str): the commit of the ns-3 installation that is used to</span>
<span class="sd">                run the simulations.</span>
<span class="sd">            params (list): a list of the parameters that can be used on the</span>
<span class="sd">                script.</span>
<span class="sd">            campaign_dir (str): The path of the file where to save the DB.</span>
<span class="sd">            overwrite (bool): Whether or not existing directories should be</span>
<span class="sd">                overwritten.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># We only accept absolute paths</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">)</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Path is not absolute&quot;</span><span class="p">)</span>

        <span class="c1"># Make sure the directory does not exist already</span>
        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="s2">&quot;The specified directory already exists&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">Path</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="c1"># Verify we are not deleting files belonging to the user</span>
            <span class="n">campaign_dir_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">)</span>
            <span class="n">folder_contents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">))</span>
            <span class="n">allowed_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="n">campaign_dir_name</span><span class="p">]</span> <span class="o">+</span>
                <span class="c1"># Allow hidden files (like .DS_STORE in macos)</span>
                <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span>
                 <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">,</span> <span class="s2">&quot;.*&quot;</span><span class="p">))])</span>

            <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">folder_contents</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">allowed_files</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The specified directory cannot be overwritten&quot;</span>
                                 <span class="s2">&quot; because it contains user files.&quot;</span><span class="p">)</span>
            <span class="c1"># This operation destroys data.</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">)</span>

        <span class="c1"># Create the directory and database file in it</span>
        <span class="c1"># The indent and separators ensure the database is human readable.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">)</span>
        <span class="n">tinydb</span> <span class="o">=</span> <span class="n">TinyDB</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.json&quot;</span> <span class="o">%</span>
                                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">)),</span>
                        <span class="n">storage</span><span class="o">=</span><span class="n">CachingMiddleware</span><span class="p">(</span><span class="n">JSONStorage</span><span class="p">))</span>

        <span class="c1"># Save the configuration in the database</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;script&#39;</span><span class="p">:</span> <span class="n">script</span><span class="p">,</span>
            <span class="s1">&#39;commit&#39;</span><span class="p">:</span> <span class="n">commit</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">params</span>
        <span class="p">}</span>

        <span class="n">tinydb</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="n">tinydb</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">tinydb</span><span class="p">,</span> <span class="n">campaign_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseManager.load"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">campaign_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize from an existing database.</span>

<span class="sd">        It is assumed that the database json file has the same name as its</span>
<span class="sd">        containing folder.</span>

<span class="sd">        Args:</span>
<span class="sd">            campaign_dir (str): The path to the campaign directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># We only accept absolute paths</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">)</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Path is not absolute&quot;</span><span class="p">)</span>

        <span class="c1"># Verify file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Directory does not exist&quot;</span><span class="p">)</span>

        <span class="c1"># Extract filename from campaign dir</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.json&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Read TinyDB instance from file</span>
            <span class="n">tinydb</span> <span class="o">=</span> <span class="n">TinyDB</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span>
                            <span class="n">storage</span><span class="o">=</span><span class="n">CachingMiddleware</span><span class="p">(</span><span class="n">JSONStorage</span><span class="p">))</span>

            <span class="c1"># Make sure the configuration is a valid dictionary</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">tinydb</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;script&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;params&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;commit&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># Remove the database instance created by tinydb</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Specified campaign directory seems corrupt&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">tinydb</span><span class="p">,</span> <span class="n">campaign_dir</span><span class="p">)</span></div>

    <span class="c1">###################</span>
    <span class="c1"># Database access #</span>
    <span class="c1">###################</span>

    <span class="k">def</span> <span class="nf">write_to_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<div class="viewcode-block" id="DatabaseManager.get_config"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.get_config">[docs]</a>    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the configuration dictionary of this DatabaseManager&#39;s campaign.</span>

<span class="sd">        This is a dictionary containing the following keys:</span>

<span class="sd">        * script: the name of the script that is executed in the campaign.</span>
<span class="sd">        * params: a list of the command line parameters that can be used on the</span>
<span class="sd">          script.</span>
<span class="sd">        * commit: the commit at which the campaign is operating.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Read from self.db and return the config entry of the database</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="DatabaseManager.get_data_dir"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.get_data_dir">[docs]</a>    <span class="k">def</span> <span class="nf">get_data_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the data directory, which is simply campaign_directory/data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">campaign_dir</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatabaseManager.get_commit"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.get_commit">[docs]</a>    <span class="k">def</span> <span class="nf">get_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the commit at which the campaign is operating.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;commit&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="DatabaseManager.get_script"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.get_script">[docs]</a>    <span class="k">def</span> <span class="nf">get_script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the ns-3 script that is run in the campaign.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;script&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="DatabaseManager.get_params"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.get_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list containing the parameters that can be toggled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="DatabaseManager.get_next_rngruns"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.get_next_rngruns">[docs]</a>    <span class="k">def</span> <span class="nf">get_next_rngruns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Yield the next RngRun values that can be used in this campaign.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">available_runs</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;RngRun&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">()]</span>
        <span class="k">yield from</span> <span class="n">DatabaseManager</span><span class="o">.</span><span class="n">get_next_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">available_runs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">insert_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>

        <span class="c1"># This dictionary serves as a model for how the keys in the newly</span>
        <span class="c1"># inserted result should be structured.</span>
        <span class="n">example_result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;...&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;RngRun&#39;</span><span class="p">]},</span>
            <span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;...&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;elapsed_time&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;exitcode&#39;</span><span class="p">]},</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="c1"># Verify result format is correct</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">DatabaseManager</span><span class="o">.</span><span class="n">have_same_structure</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">example_result</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="se">\n</span><span class="s1">Expected: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">Got: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="s2">&quot;Result dictionary does not correspond to database format&quot;</span><span class="p">,</span>
                        <span class="n">pformat</span><span class="p">(</span><span class="n">example_result</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                        <span class="n">pformat</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>

        <span class="c1"># Insert results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">insert_multiple</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<div class="viewcode-block" id="DatabaseManager.insert_result"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.insert_result">[docs]</a>    <span class="k">def</span> <span class="nf">insert_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert a new result in the database.</span>

<span class="sd">        This function also verifies that the result dictionaries saved in the</span>
<span class="sd">        database have the following structure (with {&#39;a&#39;: 1} representing a</span>
<span class="sd">        dictionary, &#39;a&#39; a key and 1 its value)::</span>

<span class="sd">            {</span>
<span class="sd">                &#39;params&#39;: {</span>
<span class="sd">                            &#39;param1&#39;: value1,</span>
<span class="sd">                            &#39;param2&#39;: value2,</span>
<span class="sd">                            ...</span>
<span class="sd">                            &#39;RngRun&#39;: value3</span>
<span class="sd">                           },</span>
<span class="sd">                &#39;meta&#39;: {</span>
<span class="sd">                          &#39;elapsed_time&#39;: value4,</span>
<span class="sd">                          &#39;id&#39;: value5</span>
<span class="sd">                        }</span>
<span class="sd">            }</span>

<span class="sd">        Where elapsed time is a float representing the seconds the simulation</span>
<span class="sd">        execution took, and id is a UUID uniquely identifying the result, and</span>
<span class="sd">        which is used to locate the output files in the campaign_dir/data</span>
<span class="sd">        folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># This dictionary serves as a model for how the keys in the newly</span>
        <span class="c1"># inserted result should be structured.</span>
        <span class="n">example_result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;...&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span>
                       <span class="p">[</span><span class="s1">&#39;RngRun&#39;</span><span class="p">]},</span>
            <span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;...&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;elapsed_time&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">]},</span>
        <span class="p">}</span>

        <span class="c1"># Verify result format is correct</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">DatabaseManager</span><span class="o">.</span><span class="n">have_same_structure</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">example_result</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="se">\n</span><span class="s1">Expected: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">Got: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="s2">&quot;Result dictionary does not correspond to database format&quot;</span><span class="p">,</span>
                    <span class="n">pformat</span><span class="p">(</span><span class="n">example_result</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                    <span class="n">pformat</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>

        <span class="c1"># Insert result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">result</span><span class="p">))</span></div>

<div class="viewcode-block" id="DatabaseManager.get_results"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.get_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">result_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return all the results available from the database that fulfill some</span>
<span class="sd">        parameter combinations.</span>

<span class="sd">        If params is None (or not specified), return all results.</span>

<span class="sd">        If params is specified, it must be a dictionary specifying the result</span>
<span class="sd">        values we are interested in, with multiple values specified as lists.</span>

<span class="sd">        For example, if the following params value is used::</span>

<span class="sd">            params = {</span>
<span class="sd">            &#39;param1&#39;: &#39;value1&#39;,</span>
<span class="sd">            &#39;param2&#39;: [&#39;value2&#39;, &#39;value3&#39;]</span>
<span class="sd">            }</span>

<span class="sd">        the database will be queried for results having param1 equal to value1,</span>
<span class="sd">        and param2 equal to value2 or value3.</span>

<span class="sd">        Not specifying a value for all the available parameters is allowed:</span>
<span class="sd">        unspecified parameters are assumed to be &#39;free&#39;, and can take any</span>
<span class="sd">        value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of results matching the query. Returned results have the</span>
<span class="sd">            same structure as results inserted with the insert_result method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># In this case, return all results</span>
        <span class="c1"># A cast to dict is necessary, since self.db.table() contains TinyDB&#39;s</span>
        <span class="c1"># Document object (which is simply a wrapper for a dictionary, thus the</span>
        <span class="c1"># simple cast).</span>
        <span class="k">if</span> <span class="n">result_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">if</span>
                    <span class="n">i</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">result_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>

        <span class="c1"># If we are passed a list of parameter combinations, we concatenate</span>
        <span class="c1"># results for the queries corresponding to each dictionary in the list</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">params</span><span class="p">],</span> <span class="p">[])</span>

        <span class="c1"># Verify parameter format is correct</span>
        <span class="n">all_params</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;RngRun&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">param_subset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_params</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">param_subset</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="se">\n</span><span class="s1">Parameters: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">Query: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="s1">&#39;Specified parameter keys do not match database format&#39;</span><span class="p">,</span>
                    <span class="n">all_params</span><span class="p">,</span>
                    <span class="n">param_subset</span><span class="p">))</span>

        <span class="c1"># Convert values that are not lists into lists to later perform</span>
        <span class="c1"># iteration over values more naturally. Perform this on a new</span>
        <span class="c1"># dictionary not to modify the original copy.</span>
        <span class="n">query_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">query_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Handle case where query params has no keys</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>

        <span class="c1"># Create the TinyDB query</span>
        <span class="c1"># In the docstring example above, this is equivalent to:</span>
        <span class="c1"># AND(OR(param1 == value1), OR(param2 == value2, param2 == value3))</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">and_</span><span class="p">,</span> <span class="p">[</span><span class="n">reduce</span><span class="p">(</span><span class="n">or_</span><span class="p">,</span> <span class="p">[</span>
            <span class="n">where</span><span class="p">(</span><span class="s1">&#39;params&#39;</span><span class="p">)[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span>
                              <span class="n">query_params</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

        <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span></div>

<div class="viewcode-block" id="DatabaseManager.get_result_files"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.get_result_files">[docs]</a>    <span class="k">def</span> <span class="nf">get_result_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary containing filename: filepath values for each</span>
<span class="sd">        output file associated with an id.</span>

<span class="sd">        Result can be either a result dictionary (e.g., obtained with the</span>
<span class="sd">        get_results() method) or a result id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">result_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Should already be a string containing the id</span>
            <span class="n">result_id</span> <span class="o">=</span> <span class="n">result</span>

        <span class="n">result_data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data_dir</span><span class="p">(),</span> <span class="n">result_id</span><span class="p">)</span>

        <span class="n">filenames</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">result_data_dir</span><span class="p">))[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">filename_path_pairs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data_dir</span><span class="p">(),</span> <span class="n">result_id</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">filename_path_pairs</span><span class="p">}</span></div>

<div class="viewcode-block" id="DatabaseManager.get_complete_results"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.get_complete_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_complete_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">result_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">files_to_load</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;.*&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return available results, analogously to what get_results does, but</span>
<span class="sd">        also read the corresponding output files for each result, and</span>
<span class="sd">        incorporate them in the result dictionary under the output key, as a</span>
<span class="sd">        dictionary of filename: file_contents.</span>

<span class="sd">        Args:</span>
<span class="sd">          params (dict): parameter specification of the desired parameter</span>
<span class="sd">            values, as described in the get_results documentation.</span>

<span class="sd">        In other words, results returned by this function will be in the form::</span>

<span class="sd">            {</span>
<span class="sd">                &#39;params&#39;: {</span>
<span class="sd">                            &#39;param1&#39;: value1,</span>
<span class="sd">                            &#39;param2&#39;: value2,</span>
<span class="sd">                            ...</span>
<span class="sd">                            &#39;RngRun&#39;: value3</span>
<span class="sd">                           },</span>
<span class="sd">                &#39;meta&#39;: {</span>
<span class="sd">                          &#39;elapsed_time&#39;: value4,</span>
<span class="sd">                          &#39;id&#39;: value5</span>
<span class="sd">                        }</span>
<span class="sd">                &#39;output&#39;: {</span>
<span class="sd">                            &#39;stdout&#39;: stdout_as_string,</span>
<span class="sd">                            &#39;stderr&#39;: stderr_as_string,</span>
<span class="sd">                            &#39;file1&#39;: file1_as_string,</span>
<span class="sd">                            ...</span>
<span class="sd">                          }</span>
<span class="sd">            }</span>

<span class="sd">        Note that the stdout and stderr entries are always included, even if</span>
<span class="sd">        they are empty.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">result_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">result_id</span><span class="o">=</span><span class="n">result_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">available_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_result_files</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">available_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">files_to_load</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">files_to_load</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">files_to_load</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files_to_load</span><span class="p">)):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_contents</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_contents</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                            <span class="c1"># If this is not decodable, we leave this output alone</span>
                            <span class="c1"># (but still insert its name in the result)</span>
                            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RAW&#39;</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="DatabaseManager.wipe_results"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.wipe_results">[docs]</a>    <span class="k">def</span> <span class="nf">wipe_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove all results from the database.</span>

<span class="sd">        This also removes all output files, and cannot be undone.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Clean results table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_to_disk</span><span class="p">()</span>

        <span class="c1"># Get rid of contents of data dir</span>
        <span class="nb">map</span><span class="p">(</span><span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">,</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data_dir</span><span class="p">(),</span> <span class="s1">&#39;*.*&#39;</span><span class="p">)))</span></div>

<div class="viewcode-block" id="DatabaseManager.delete_result"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.delete_result">[docs]</a>    <span class="k">def</span> <span class="nf">delete_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove the specified result from the database, based on its id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get rid of contents of data dir</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data_dir</span><span class="p">(),</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
        <span class="c1"># Remove entry from results table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">)[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_to_disk</span><span class="p">()</span></div>

    <span class="c1">#############</span>
    <span class="c1"># Utilities #</span>
    <span class="c1">#############</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Represent the database object as a human-readable string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">configuration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
        <span class="k">return</span> <span class="s2">&quot;script: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">params: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">HEAD: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">],</span> <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">],</span>
            <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;commit&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="DatabaseManager.get_next_values"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.get_next_values">[docs]</a>    <span class="k">def</span> <span class="nf">get_next_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a list of integers, this method yields the lowest integers that</span>
<span class="sd">        do not appear in the list.</span>

<span class="sd">        &gt;&gt;&gt; import sem</span>
<span class="sd">        &gt;&gt;&gt; v = [0, 1, 3, 4]</span>
<span class="sd">        &gt;&gt;&gt; sem.DatabaseManager.get_next_values(v)</span>

<span class="sd">        [2, 5, 6, ...]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values_list</span><span class="p">,</span>
                          <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">())</span></div>

<div class="viewcode-block" id="DatabaseManager.have_same_structure"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.have_same_structure">[docs]</a>    <span class="k">def</span> <span class="nf">have_same_structure</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given two dictionaries (possibly with other nested dictionaries as</span>
<span class="sd">        values), this function checks whether they have the same key structure.</span>

<span class="sd">        &gt;&gt;&gt; from sem import DatabaseManager</span>
<span class="sd">        &gt;&gt;&gt; d1 = {&#39;a&#39;: 1, &#39;b&#39;: 2}</span>
<span class="sd">        &gt;&gt;&gt; d2 = {&#39;a&#39;: [], &#39;b&#39;: 3}</span>
<span class="sd">        &gt;&gt;&gt; d3 = {&#39;a&#39;: 4, &#39;c&#39;: 5}</span>
<span class="sd">        &gt;&gt;&gt; DatabaseManager.have_same_structure(d1, d2)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; DatabaseManager.have_same_structure(d1, d3)</span>
<span class="sd">        False</span>

<span class="sd">        &gt;&gt;&gt; d4 = {&#39;a&#39;: {&#39;c&#39;: 1}, &#39;b&#39;: 2}</span>
<span class="sd">        &gt;&gt;&gt; d5 = {&#39;a&#39;: {&#39;c&#39;: 3}, &#39;b&#39;: 4}</span>
<span class="sd">        &gt;&gt;&gt; d6 = {&#39;a&#39;: {&#39;c&#39;: 5, &#39;d&#39;: 6}, &#39;b&#39;: 7}</span>
<span class="sd">        &gt;&gt;&gt; DatabaseManager.have_same_structure(d1, d4)</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; DatabaseManager.have_same_structure(d4, d5)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; DatabaseManager.have_same_structure(d4, d6)</span>
<span class="sd">        False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Keys of this level are the same</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">d2</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check nested dictionaries</span>
        <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d2</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="c1"># If one of the values is a dictionary and the other is not</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k1</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d2</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="c1"># If both are dictionaries, recur</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k1</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d2</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">DatabaseManager</span><span class="o">.</span><span class="n">have_same_structure</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k1</span><span class="p">],</span> <span class="n">d2</span><span class="p">[</span><span class="n">k2</span><span class="p">]):</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DatabaseManager.get_all_values_of_all_params"><a class="viewcode-back" href="../../api.html#sem.DatabaseManager.get_all_values_of_all_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_values_of_all_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary containing all values that are taken by all</span>
<span class="sd">        available parameters.</span>

<span class="sd">        Always returns the parameter list in alphabetical order.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([[</span><span class="n">p</span><span class="p">,</span> <span class="p">[]]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span>
                                          <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">())])</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">():</span>
                <span class="n">values</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="n">param</span><span class="p">]]</span>

        <span class="n">sorted_values</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([[</span><span class="n">k</span><span class="p">,</span>
                                                 <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">k</span><span class="p">])))]</span>
                                                 <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sorted_values</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sorted_values</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">sorted_values</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">sorted_values</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3><a href="../../index.html">Home</a></h3><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Davide Magrin.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>