
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sem.manager &#8212; sem 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for sem.manager</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">shuffle</span>

<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">savemat</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">.database</span> <span class="kn">import</span> <span class="n">DatabaseManager</span>
<span class="kn">from</span> <span class="nn">.lptrunner</span> <span class="kn">import</span> <span class="n">LptRunner</span>
<span class="kn">from</span> <span class="nn">.parallelrunner</span> <span class="kn">import</span> <span class="n">ParallelRunner</span>
<span class="kn">from</span> <span class="nn">.conditionalrunner</span> <span class="kn">import</span> <span class="n">ConditionalRunner</span>
<span class="kn">from</span> <span class="nn">.runner</span> <span class="kn">import</span> <span class="n">SimulationRunner</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">DRMAA_AVAILABLE</span><span class="p">,</span> <span class="n">list_param_combinations</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">if</span> <span class="n">DRMAA_AVAILABLE</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.gridrunner</span> <span class="kn">import</span> <span class="n">GridRunner</span>

<span class="k">def</span> <span class="nf">parse_result</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">function_yields_multiple_results</span><span class="p">,</span> <span class="n">result_parsing_function</span><span class="p">,</span> <span class="n">param_columns</span> <span class="o">=</span> <span class="n">param</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">function_yields_multiple_results</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result_parsing_function</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="n">param_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">param_columns</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">param_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">param_values_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">param_keys</span><span class="p">,</span> <span class="n">param_values</span><span class="p">))</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">param_columns</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param_values_to_keep</span> <span class="o">=</span> <span class="n">param_values</span>
            <span class="n">param_values_to_keep</span> <span class="o">+=</span> <span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">r</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="p">[</span><span class="n">param_values_to_keep</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">param_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">param_columns</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">param_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">param_values_to_keep</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">param_keys</span><span class="p">,</span> <span class="n">param_values</span><span class="p">))</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">param_columns</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">param_values_to_keep</span> <span class="o">=</span> <span class="n">param_values</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">result_parsing_function</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">param_values_to_keep</span> <span class="o">+=</span> <span class="p">[</span><span class="n">parsed</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">parsed</span>
        <span class="n">data</span> <span class="o">+=</span> <span class="p">[</span><span class="n">param_values_to_keep</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data</span>

<div class="viewcode-block" id="CampaignManager"><a class="viewcode-back" href="../../api.html#sem.CampaignManager">[docs]</a><span class="k">class</span> <span class="nc">CampaignManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This Simulation Execution Manager class can be used as an interface to</span>
<span class="sd">    execute simulations and access the results of simulation campaigns.</span>

<span class="sd">    The CampaignManager class wraps up a DatabaseManager and a</span>
<span class="sd">    SimulationRunner, which are used internally but can also be accessed as</span>
<span class="sd">    public member variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#######################################</span>
    <span class="c1"># Campaign initialization and loading #</span>
    <span class="c1">#######################################</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">campaign_db</span><span class="p">,</span> <span class="n">campaign_runner</span><span class="p">,</span> <span class="n">check_repo</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Simulation Execution Manager, using the provided</span>
<span class="sd">        CampaignManager and SimulationRunner instances.</span>

<span class="sd">        This method should never be used on its own, but only as a constructor</span>
<span class="sd">        from the new and load @classmethods.</span>

<span class="sd">        Args:</span>
<span class="sd">            campaign_db (DatabaseManager): the DatabaseManager object to</span>
<span class="sd">                associate to this campaign.</span>
<span class="sd">            campaign_runner (SimulationRunner): the SimulationRunner object to</span>
<span class="sd">                associate to this campaign.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">campaign_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="n">campaign_runner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_repo</span> <span class="o">=</span> <span class="n">check_repo</span>

        <span class="c1"># Check that the current repo commit corresponds to the one specified</span>
        <span class="c1"># in the campaign</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_repo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_repo_ok</span><span class="p">()</span>

<div class="viewcode-block" id="CampaignManager.new"><a class="viewcode-back" href="../../api.html#sem.CampaignManager.new">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ns_path</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">campaign_dir</span><span class="p">,</span> <span class="n">runner_type</span><span class="o">=</span><span class="s1">&#39;Auto&#39;</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optimized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check_repo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">skip_configuration</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_parallel_processes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new campaign from an ns-3 installation and a campaign</span>
<span class="sd">        directory.</span>

<span class="sd">        This method will create a DatabaseManager, which will install a</span>
<span class="sd">        database in the specified campaign_dir. If a database is already</span>
<span class="sd">        available at the ns_path described in the specified campaign_dir and</span>
<span class="sd">        its configuration matches config, this instance is used instead. If the</span>
<span class="sd">        overwrite argument is set to True instead, the specified directory is</span>
<span class="sd">        wiped and a new campaign is created in its place.</span>

<span class="sd">        Furthermore, this method will initialize a SimulationRunner, of type</span>
<span class="sd">        specified by the runner_type parameter, which will be locked on the</span>
<span class="sd">        ns-3 installation at ns_path and set up to run the desired script.</span>

<span class="sd">        Finally, note that creation of a campaign requires a git repository to</span>
<span class="sd">        be initialized at the specified ns_path. This will allow SEM to save</span>
<span class="sd">        the commit at which the simulations are run, enforce reproducibility</span>
<span class="sd">        and avoid mixing results coming from different versions of ns-3 and its</span>
<span class="sd">        libraries.</span>

<span class="sd">        Args:</span>
<span class="sd">            ns_path (str): path to the ns-3 installation to employ in this</span>
<span class="sd">                campaign.</span>
<span class="sd">            script (str): ns-3 script that will be executed to run simulations.</span>
<span class="sd">            campaign_dir (str): path to the directory in which to save the</span>
<span class="sd">                simulation campaign database.</span>
<span class="sd">            runner_type (str): implementation of the SimulationRunner to use.</span>
<span class="sd">                Value can be: SimulationRunner (for running sequential</span>
<span class="sd">                simulations locally), ParallelRunner (for running parallel</span>
<span class="sd">                simulations locally), GridRunner (for running simulations using</span>
<span class="sd">                a DRMAA-compatible parallel task scheduler). Use Auto to</span>
<span class="sd">                automatically pick the best runner.</span>
<span class="sd">            overwrite (bool): whether to overwrite already existing</span>
<span class="sd">                campaign_dir folders. This deletes the directory if and only if</span>
<span class="sd">                it only contains files that were detected to be created by sem.</span>
<span class="sd">            optimized (bool): whether to configure the runner to employ an</span>
<span class="sd">                optimized ns-3 build.</span>
<span class="sd">            skip_configuration (bool): whether to skip the configuration step,</span>
<span class="sd">                and only perform compilation.</span>
<span class="sd">                NOTE: if skip_configuration=True and optimized=True, the build</span>
<span class="sd">                folder should be manually set to --out=build/optimized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert paths to be absolute</span>
        <span class="n">ns_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">ns_path</span><span class="p">)</span>
        <span class="n">campaign_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">)</span>

        <span class="c1"># Verify if the specified campaign is already available</span>
        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="c1"># Try loading</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">CampaignManager</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">,</span> <span class="n">ns_path</span><span class="p">,</span>
                                           <span class="n">runner_type</span><span class="o">=</span><span class="n">runner_type</span><span class="p">,</span>
                                           <span class="n">optimized</span><span class="o">=</span><span class="n">optimized</span><span class="p">,</span>
                                           <span class="n">check_repo</span><span class="o">=</span><span class="n">check_repo</span><span class="p">,</span>
                                           <span class="n">skip_configuration</span><span class="o">=</span><span class="n">skip_configuration</span><span class="p">,</span>
                                           <span class="n">max_parallel_processes</span><span class="o">=</span><span class="n">max_parallel_processes</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_script</span><span class="p">()</span> <span class="o">==</span> <span class="n">script</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">manager</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">manager</span>

        <span class="c1"># Initialize runner</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="n">CampaignManager</span><span class="o">.</span><span class="n">create_runner</span><span class="p">(</span><span class="n">ns_path</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span>
                                               <span class="n">runner_type</span><span class="o">=</span><span class="n">runner_type</span><span class="p">,</span>
                                               <span class="n">optimized</span><span class="o">=</span><span class="n">optimized</span><span class="p">,</span>
                                               <span class="n">skip_configuration</span><span class="o">=</span><span class="n">skip_configuration</span><span class="p">,</span>
                                               <span class="n">max_parallel_processes</span><span class="o">=</span><span class="n">max_parallel_processes</span><span class="p">)</span>

        <span class="c1"># Get list of parameters to save in the DB</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">get_available_parameters</span><span class="p">()</span>

        <span class="c1"># Get current commit</span>
        <span class="n">commit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">check_repo</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">git</span> <span class="kn">import</span> <span class="n">Repo</span><span class="p">,</span> <span class="n">exc</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">Repo</span><span class="p">(</span><span class="n">ns_path</span><span class="p">)</span>
            <span class="n">commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">hexsha</span>
            <span class="k">if</span> <span class="n">repo</span><span class="o">.</span><span class="n">is_dirty</span><span class="p">(</span><span class="n">untracked_files</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ns-3 repository is not clean&quot;</span><span class="p">)</span>

        <span class="c1"># Create a database manager from the configuration</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">script</span><span class="o">=</span><span class="n">script</span><span class="p">,</span>
                                 <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                                 <span class="n">commit</span><span class="o">=</span><span class="n">commit</span><span class="p">,</span>
                                 <span class="n">campaign_dir</span><span class="o">=</span><span class="n">campaign_dir</span><span class="p">,</span>
                                 <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">runner</span><span class="p">,</span> <span class="n">check_repo</span><span class="p">)</span></div>

<div class="viewcode-block" id="CampaignManager.load"><a class="viewcode-back" href="../../api.html#sem.CampaignManager.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">campaign_dir</span><span class="p">,</span> <span class="n">ns_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">runner_type</span><span class="o">=</span><span class="s1">&#39;Auto&#39;</span><span class="p">,</span>
             <span class="n">optimized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check_repo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_configuration</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">max_parallel_processes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load an existing simulation campaign.</span>

<span class="sd">        Note that specifying an ns-3 installation is not compulsory when using</span>
<span class="sd">        this method: existing results will be available, but in order to run</span>
<span class="sd">        additional simulations it will be necessary to specify a</span>
<span class="sd">        SimulationRunner object, and assign it to the CampaignManager.</span>

<span class="sd">        Args:</span>
<span class="sd">            campaign_dir (str): path to the directory in which to save the</span>
<span class="sd">                simulation campaign database.</span>
<span class="sd">            ns_path (str): path to the ns-3 installation to employ in this</span>
<span class="sd">                campaign.</span>
<span class="sd">            runner_type (str): implementation of the SimulationRunner to use.</span>
<span class="sd">                Value can be: SimulationRunner (for running sequential</span>
<span class="sd">                simulations locally), ParallelRunner (for running parallel</span>
<span class="sd">                simulations locally), GridRunner (for running simulations using</span>
<span class="sd">                a DRMAA-compatible parallel task scheduler).</span>
<span class="sd">            optimized (bool): whether to configure the runner to employ an</span>
<span class="sd">                optimized ns-3 build.</span>
<span class="sd">            skip_configuration (bool): whether to skip the configuration step,</span>
<span class="sd">                and only perform compilation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert paths to be absolute</span>
        <span class="k">if</span> <span class="n">ns_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ns_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">ns_path</span><span class="p">)</span>
        <span class="n">campaign_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">)</span>

        <span class="c1"># Read the existing configuration into the new DatabaseManager</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">campaign_dir</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_script</span><span class="p">()</span>

        <span class="n">runner</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ns_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">runner</span> <span class="o">=</span> <span class="n">CampaignManager</span><span class="o">.</span><span class="n">create_runner</span><span class="p">(</span><span class="n">ns_path</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span>
                                                   <span class="n">runner_type</span><span class="p">,</span> <span class="n">optimized</span><span class="p">,</span>
                                                   <span class="n">skip_configuration</span><span class="p">,</span>
                                                   <span class="n">max_parallel_processes</span><span class="o">=</span><span class="n">max_parallel_processes</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">runner</span><span class="p">,</span> <span class="n">check_repo</span><span class="p">)</span></div>

<div class="viewcode-block" id="CampaignManager.create_runner"><a class="viewcode-back" href="../../api.html#sem.CampaignManager.create_runner">[docs]</a>    <span class="k">def</span> <span class="nf">create_runner</span><span class="p">(</span><span class="n">ns_path</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">runner_type</span><span class="o">=</span><span class="s1">&#39;Auto&#39;</span><span class="p">,</span>
                      <span class="n">optimized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_configuration</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">max_parallel_processes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a SimulationRunner from a string containing the desired</span>
<span class="sd">        class implementation, and return it.</span>

<span class="sd">        Args:</span>
<span class="sd">            ns_path (str): path to the ns-3 installation to employ in this</span>
<span class="sd">                SimulationRunner.</span>
<span class="sd">            script (str): ns-3 script that will be executed to run simulations.</span>
<span class="sd">            runner_type (str): implementation of the SimulationRunner to use.</span>
<span class="sd">                Value can be: SimulationRunner (for running sequential</span>
<span class="sd">                simulations locally), ParallelRunner (for running parallel</span>
<span class="sd">                simulations locally), GridRunner (for running simulations using</span>
<span class="sd">                a DRMAA-compatible parallel task scheduler). If Auto,</span>
<span class="sd">                automatically pick the best available runner (GridRunner if</span>
<span class="sd">                DRMAA is available, ParallelRunner otherwise).</span>
<span class="sd">            optimized (bool): whether to configure the runner to employ an</span>
<span class="sd">                optimized ns-3 build.</span>
<span class="sd">            skip_configuration (bool): whether to skip the configuration step,</span>
<span class="sd">                and only perform compilation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># locals() contains a dictionary pairing class names with class</span>
        <span class="c1"># objects: we can create the object using the desired class starting</span>
        <span class="c1"># from its name.</span>
        <span class="k">if</span> <span class="n">runner_type</span> <span class="o">==</span> <span class="s1">&#39;Auto&#39;</span> <span class="ow">and</span> <span class="n">DRMAA_AVAILABLE</span><span class="p">:</span>
            <span class="n">runner_type</span> <span class="o">=</span> <span class="s1">&#39;GridRunner&#39;</span>
        <span class="k">elif</span> <span class="n">runner_type</span> <span class="o">==</span> <span class="s1">&#39;Auto&#39;</span><span class="p">:</span>
            <span class="n">runner_type</span> <span class="o">=</span> <span class="s1">&#39;ParallelRunner&#39;</span>

        <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">runner_type</span><span class="p">,</span>
                            <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">runner_type</span><span class="p">))(</span>
                                <span class="n">ns_path</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">optimized</span><span class="o">=</span><span class="n">optimized</span><span class="p">,</span>
                                <span class="n">skip_configuration</span><span class="o">=</span><span class="n">skip_configuration</span><span class="p">,</span>
                                <span class="n">max_parallel_processes</span><span class="o">=</span><span class="n">max_parallel_processes</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">check_and_fill_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_list</span><span class="p">,</span> <span class="n">needs_rngrun</span><span class="p">):</span>
        <span class="c1"># Check all parameter combinations fully specify the desired simulation</span>
        <span class="n">desired_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
            <span class="c1"># Besides the parameters that were actually passed, we add the ones</span>
            <span class="c1"># that are always available in every script</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">parameter</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parameter</span> <span class="o">=</span> <span class="n">p</span>
            <span class="n">passed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">parameter</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">available</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RngRun&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">desired_params</span> <span class="k">if</span> <span class="n">needs_rngrun</span> <span class="k">else</span> <span class="n">desired_params</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">available</span><span class="p">):</span>
                <span class="n">not_supported_parameters</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">available</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">not_supported_parameters</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The following parameters are &quot;</span>
                                     <span class="s2">&quot;not supported by the script: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>
                                     <span class="n">not_supported_parameters</span><span class="p">)</span>
            <span class="c1"># Automatically fill remaining parameters with defaults</span>
            <span class="n">additional_required_parameters</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">available</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">passed</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">additional_parameter</span> <span class="ow">in</span> <span class="n">additional_required_parameters</span><span class="p">:</span>
                <span class="n">p</span><span class="p">[</span><span class="n">additional_parameter</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_params</span><span class="p">()[</span><span class="n">additional_parameter</span><span class="p">]</span>

    <span class="c1">######################</span>
    <span class="c1"># Simulation running #</span>
    <span class="c1">######################</span>

<div class="viewcode-block" id="CampaignManager.run_simulations"><a class="viewcode-back" href="../../api.html#sem.CampaignManager.run_simulations">[docs]</a>    <span class="k">def</span> <span class="nf">run_simulations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_list</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stop_on_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run several simulations specified by a list of parameter combinations.</span>

<span class="sd">        Note: this function does not verify whether we already have the</span>
<span class="sd">        required simulations in the database - it just runs all the parameter</span>
<span class="sd">        combinations that are specified in the list.</span>

<span class="sd">        Args:</span>
<span class="sd">            param_list (list): list of parameter combinations to execute.</span>
<span class="sd">                Items of this list are dictionaries, with one key for each</span>
<span class="sd">                parameter, and a value specifying the parameter value (which</span>
<span class="sd">                can be either a string or a number).</span>
<span class="sd">            show_progress (bool): whether or not to show a progress bar with</span>
<span class="sd">                percentage and expected remaining time.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Make sure we have a runner to run simulations with.</span>
        <span class="c1"># This can happen in case the simulation campaign is loaded and not</span>
        <span class="c1"># created from scratch.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No runner was ever specified&quot;</span>
                            <span class="s2">&quot; for this CampaignManager.&quot;</span><span class="p">)</span>

        <span class="c1"># Return if the list is empty</span>
        <span class="k">if</span> <span class="n">param_list</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_and_fill_parameters</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="n">needs_rngrun</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check that the current repo commit corresponds to the one specified</span>
        <span class="c1"># in the campaign</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_repo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_repo_ok</span><span class="p">()</span>

        <span class="c1"># Build ns-3 before running any simulations</span>
        <span class="c1"># At this point, we can assume the project was already configured</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">configure_and_build</span><span class="p">(</span><span class="n">skip_configuration</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Shuffle simulations</span>
        <span class="c1"># This mixes up long and short simulations, and gives better time</span>
        <span class="c1"># estimates for the simple ParallelRunner.</span>
        <span class="n">shuffle</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span>

        <span class="c1"># Offload simulation execution to self.runner</span>
        <span class="c1"># Note that this only creates a generator for the results, no</span>
        <span class="c1"># computation is performed on this line.</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">run_simulations</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_data_dir</span><span class="p">(),</span>
                                              <span class="n">stop_on_errors</span><span class="o">=</span><span class="n">stop_on_errors</span><span class="p">)</span>

        <span class="c1"># Wrap the result generator in the progress bar generator.</span>
        <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
            <span class="n">result_generator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">param_list</span><span class="p">),</span>
                                    <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;simulation&#39;</span><span class="p">,</span>
                                    <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Running simulations&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result_generator</span> <span class="o">=</span> <span class="n">results</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_and_save_results</span><span class="p">(</span><span class="n">result_generator</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">run_and_save_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_generator</span><span class="p">,</span> <span class="n">batch_results</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Insert result object in db. Using the generator here ensures we</span>
        <span class="c1"># save results as they are finalized by the SimulationRunner, and</span>
        <span class="c1"># that they are kept even if execution is terminated abruptly by</span>
        <span class="c1"># crashes or by a KeyboardInterrupt.</span>
        <span class="n">results_batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last_save_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_generator</span><span class="p">:</span>

            <span class="n">results_batch</span> <span class="o">+=</span> <span class="p">[</span><span class="n">result</span><span class="p">]</span>

            <span class="c1"># Save results to disk once every 60 seconds</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_results</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">insert_results</span><span class="p">(</span><span class="n">results_batch</span><span class="p">)</span>
                <span class="n">results_batch</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">batch_results</span> <span class="ow">and</span>
                  <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_save_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">insert_results</span><span class="p">(</span><span class="n">results_batch</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">write_to_disk</span><span class="p">()</span>
                <span class="n">results_batch</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">last_save_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">insert_results</span><span class="p">(</span><span class="n">results_batch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">write_to_disk</span><span class="p">()</span>

<div class="viewcode-block" id="CampaignManager.get_missing_simulations"><a class="viewcode-back" href="../../api.html#sem.CampaignManager.get_missing_simulations">[docs]</a>    <span class="k">def</span> <span class="nf">get_missing_simulations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_list</span><span class="p">,</span> <span class="n">runs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">with_time_estimate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of the simulations among the required ones that are not</span>
<span class="sd">        available in the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            param_list (list): a list of dictionaries containing all the</span>
<span class="sd">                parameters combinations.</span>
<span class="sd">            runs (int): an integer representing how many repetitions are wanted</span>
<span class="sd">                for each parameter combination, None if the dictionaries in</span>
<span class="sd">                param_list already feature the desired RngRun value.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">params_to_simulate</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Fill up a possibly impartial parameter definition with defaults</span>
        <span class="k">if</span> <span class="n">runs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_and_fill_parameters</span> <span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="n">needs_rngrun</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_and_fill_parameters</span> <span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="n">needs_rngrun</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">runs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Get next available runs from the database</span>
            <span class="n">next_runs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_next_rngruns</span><span class="p">()</span>
            <span class="n">available_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_results</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">param_comb</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
                <span class="c1"># Count how many param combinations we found, and remove them</span>
                <span class="c1"># from the list of available_results for faster searching in the</span>
                <span class="c1"># future</span>
                <span class="n">needed_runs</span> <span class="o">=</span> <span class="n">runs</span>
                <span class="k">if</span> <span class="n">with_time_estimate</span><span class="p">:</span>
                    <span class="n">time_prediction</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;Inf&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">available_results</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">param_comb</span> <span class="o">==</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>
                                      <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;RngRun&quot;</span><span class="p">}:</span>
                        <span class="n">needed_runs</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">with_time_estimate</span><span class="p">:</span>
                            <span class="n">time_prediction</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;elapsed_time&#39;</span><span class="p">])</span>
                <span class="n">new_param_combs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">needed_run</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">needed_runs</span><span class="p">):</span>
                    <span class="c1"># Here it&#39;s important that we make copies of the</span>
                    <span class="c1"># dictionaries, so that if we modify one we don&#39;t modify</span>
                    <span class="c1"># the others. This is necessary because after this step,</span>
                    <span class="c1"># typically, we will add the RngRun key which must be</span>
                    <span class="c1"># different for each copy.</span>
                    <span class="n">new_param</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">param_comb</span><span class="p">)</span>
                    <span class="n">new_param</span><span class="p">[</span><span class="s1">&#39;RngRun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">next_runs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">with_time_estimate</span><span class="p">:</span>
                        <span class="n">new_param_combs</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">new_param</span><span class="p">,</span> <span class="n">time_prediction</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_param_combs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">new_param</span><span class="p">]</span>
                <span class="n">params_to_simulate</span> <span class="o">+=</span> <span class="n">new_param_combs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param_comb</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
                <span class="n">previous_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">param_comb</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">previous_results</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">with_time_estimate</span><span class="p">:</span>
                        <span class="c1"># Try and find results with different RngRun to provide</span>
                        <span class="c1"># a time prediction</span>
                        <span class="n">param_comb_no_rngrun</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">param_comb</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>
                                                <span class="n">param_comb</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;RngRun&quot;</span><span class="p">}</span>
                        <span class="n">prev_results_different_rngrun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">param_comb_no_rngrun</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">prev_results_different_rngrun</span><span class="p">:</span>
                            <span class="n">time_prediction</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">prev_results_different_rngrun</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;elapsed_time&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">time_prediction</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;Inf&quot;</span><span class="p">)</span>
                        <span class="n">params_to_simulate</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">param_comb</span><span class="p">,</span> <span class="n">time_prediction</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">params_to_simulate</span> <span class="o">+=</span> <span class="p">[</span><span class="n">param_comb</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">params_to_simulate</span></div>

<div class="viewcode-block" id="CampaignManager.run_missing_simulations"><a class="viewcode-back" href="../../api.html#sem.CampaignManager.run_missing_simulations">[docs]</a>    <span class="k">def</span> <span class="nf">run_missing_simulations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_list</span><span class="p">,</span> <span class="n">runs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">condition_checking_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">stop_on_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the simulations from the parameter list that are not yet available</span>
<span class="sd">        in the database.</span>

<span class="sd">        This function also makes sure that we have at least runs replications</span>
<span class="sd">        for each parameter combination.</span>

<span class="sd">        Additionally, param_list can either be a list containing the desired</span>
<span class="sd">        parameter combinations or a dictionary containing multiple values for</span>
<span class="sd">        each parameter, to be expanded into a list.</span>

<span class="sd">        Args:</span>
<span class="sd">            param_list (list, dict): either a list of parameter combinations or</span>
<span class="sd">                a dictionary to be expanded into a list through the</span>
<span class="sd">                list_param_combinations function.</span>
<span class="sd">            runs (int): the number of runs to perform for each parameter</span>
<span class="sd">                combination. This parameter is only allowed if the param_list</span>
<span class="sd">                specification doesn&#39;t feature an &#39;RngRun&#39; key already.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Expand the parameter specification</span>
        <span class="n">param_list</span> <span class="o">=</span> <span class="n">list_param_combinations</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span>

        <span class="c1"># In this case, we need to run simulations in batches</span>
        <span class="k">if</span> <span class="n">runs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">condition_checking_function</span><span class="p">:</span>
            <span class="n">next_runs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_next_rngruns</span><span class="p">()</span>
            <span class="c1"># Create a ConditionalRunner</span>
            <span class="n">cr</span> <span class="o">=</span> <span class="n">ConditionalRunner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">script</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">optimized</span><span class="p">,</span>
                                   <span class="n">max_parallel_processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">max_parallel_processes</span><span class="p">)</span>
            <span class="c1"># Set up the runner&#39;s stopping condition function</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">stopping_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">condition_checking_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="c1"># Set up the runner&#39;s iterator for next runs</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">next_runs</span> <span class="o">=</span> <span class="n">next_runs</span>

            <span class="c1"># Fill up a possibly impartial parameter definition with defaults</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_and_fill_parameters</span> <span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="n">needs_rngrun</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">run_and_save_results</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">run_simulations</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_data_dir</span><span class="p">(),</span>
                                                         <span class="n">stop_on_errors</span><span class="o">=</span><span class="n">stop_on_errors</span><span class="p">),</span>
                                      <span class="n">batch_results</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Otherwise, we just run all required runs for each combination</span>
        <span class="k">if</span> <span class="n">condition_checking_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If we are passed a list already, just run the missing simulations</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span> <span class="n">LptRunner</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_simulations</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_missing_simulations</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span>
                                                 <span class="n">runs</span><span class="p">,</span>
                                                 <span class="n">with_time_estimate</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                    <span class="n">stop_on_errors</span><span class="o">=</span><span class="n">stop_on_errors</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_simulations</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_missing_simulations</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="n">runs</span><span class="p">),</span>
                    <span class="n">stop_on_errors</span><span class="o">=</span><span class="n">stop_on_errors</span><span class="p">)</span></div>

    <span class="c1">#####################</span>
    <span class="c1"># Result management #</span>
    <span class="c1">#####################</span>

<div class="viewcode-block" id="CampaignManager.get_results_as_dataframe"><a class="viewcode-back" href="../../api.html#sem.CampaignManager.get_results_as_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_results_as_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">result_parsing_function</span><span class="p">,</span>
                                 <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">runs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">param_columns</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
                                 <span class="n">drop_constant_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">parallel_parsing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a Pandas DataFrame containing results parsed using a</span>
<span class="sd">        user-specified function.</span>

<span class="sd">        If function_yields_multiple_results if False, result_parsing_function is</span>
<span class="sd">        expected to return a list of outputs for each parsed result, and column</span>
<span class="sd">        should contain an equal number of labels describing the contents of the</span>
<span class="sd">        output list.</span>

<span class="sd">        If function_yields_multiple_results is True, instead,</span>
<span class="sd">        result_parsing_function is expected to return multiple lists of outputs,</span>
<span class="sd">        as described by the labels in columns, for each result. In this case,</span>
<span class="sd">        each result in the database will yield a number of rows in the output</span>
<span class="sd">        dataframe that is equal to the length of the result_parsing_function</span>
<span class="sd">        output computed on that result.</span>

<span class="sd">        Args:</span>
<span class="sd">            result_parsing_function (function): user-defined function, taking a</span>
<span class="sd">                result dictionary as input and returning a list of outputs or a list</span>
<span class="sd">                of lists of outputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param_combination</span> <span class="ow">in</span> <span class="n">list_param_combinations</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">runs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">results_list</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">param_combination</span><span class="p">))[:</span><span class="n">runs</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results_list</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">param_combination</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_results</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">result_parsing_function</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_to_load&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">files_to_load</span> <span class="o">=</span> <span class="n">result_parsing_function</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;files_to_load&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">files_to_load</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;.*&quot;</span>

        <span class="k">if</span> <span class="n">result_parsing_function</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;yields_multiple_results&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">function_yields_multiple_results</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">function_yields_multiple_results</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">result_parsing_function</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_labels&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please either specify a column parameter or decorate your function with the @sem.utils.output_labels decorator&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">result_parsing_function</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;output_labels&#39;</span><span class="p">]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">parallel_parsing</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">max_parallel_processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">parsed_result</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">parse_result</span><span class="p">,</span>
                                                              <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_complete_results</span><span class="p">(</span><span class="n">result_id</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                                                                                             <span class="n">files_to_load</span><span class="o">=</span><span class="n">files_to_load</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                                                <span class="n">function_yields_multiple_results</span><span class="p">,</span>
                                                                <span class="n">result_parsing_function</span><span class="p">,</span>
                                                                <span class="n">param_columns</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results_list</span><span class="p">]),</span>
                                          <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">results_list</span><span class="p">),</span>
                                          <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;result&#39;</span><span class="p">,</span>
                                          <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Parsing Results&#39;</span><span class="p">,</span>
                                          <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">):</span>
                    <span class="n">data</span> <span class="o">+=</span> <span class="n">parsed_result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">parsed_result</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">((</span><span class="n">parse_result</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_complete_results</span><span class="p">(</span><span class="n">result_id</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                                                                                  <span class="n">files_to_load</span><span class="o">=</span><span class="n">files_to_load</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                                     <span class="n">function_yields_multiple_results</span><span class="p">,</span>
                                                     <span class="n">result_parsing_function</span><span class="p">,</span>
                                                     <span class="n">param_columns</span><span class="p">])</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results_list</span><span class="p">),</span>
                                      <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">results_list</span><span class="p">),</span>
                                      <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;result&#39;</span><span class="p">,</span>
                                      <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Parsing Results&#39;</span><span class="p">,</span>
                                      <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">+=</span> <span class="n">parsed_result</span>

        <span class="k">if</span> <span class="n">param_columns</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">param_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_results</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">all_columns</span> <span class="o">=</span> <span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_results</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">param_columns</span><span class="p">]</span> <span class="o">+</span> <span class="n">columns</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">all_columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">drop_constant_columns</span><span class="p">:</span>
            <span class="n">nunique</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">nunique</span><span class="p">)</span>
            <span class="n">cols_to_drop</span> <span class="o">=</span> <span class="n">nunique</span><span class="p">[</span><span class="n">nunique</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cols_to_drop</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="CampaignManager.get_results_as_numpy_array"><a class="viewcode-back" href="../../api.html#sem.CampaignManager.get_results_as_numpy_array">[docs]</a>    <span class="k">def</span> <span class="nf">get_results_as_numpy_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_space</span><span class="p">,</span>
                                   <span class="n">result_parsing_function</span><span class="p">,</span> <span class="n">runs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">extract_complete_results</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the results relative to the desired parameter space in the form</span>
<span class="sd">        of a numpy array.</span>

<span class="sd">        Args:</span>
<span class="sd">            parameter_space (dict): dictionary containing</span>
<span class="sd">                parameter/list-of-values pairs.</span>
<span class="sd">            result_parsing_function (function): user-defined function, taking a</span>
<span class="sd">                result dictionary as argument, that can be used to parse the</span>
<span class="sd">                result files and return a list of values.</span>
<span class="sd">            runs (int): number of runs to gather for each parameter</span>
<span class="sd">                combination.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_space</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_results</span><span class="p">(),</span> <span class="p">{},</span>
            <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span>
                                     <span class="n">parameter_space</span><span class="o">.</span><span class="n">items</span><span class="p">()]),</span>
            <span class="n">result_parsing_function</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">extract_complete_results</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="CampaignManager.save_to_mat_file"><a class="viewcode-back" href="../../api.html#sem.CampaignManager.save_to_mat_file">[docs]</a>    <span class="k">def</span> <span class="nf">save_to_mat_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_space</span><span class="p">,</span>
                         <span class="n">result_parsing_function</span><span class="p">,</span>
                         <span class="n">filename</span><span class="p">,</span> <span class="n">runs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the results relative to the desired parameter space in the form</span>
<span class="sd">        of a .mat file.</span>

<span class="sd">        Args:</span>
<span class="sd">            parameter_space (dict): dictionary containing</span>
<span class="sd">                parameter/list-of-values pairs.</span>
<span class="sd">            result_parsing_function (function): user-defined function, taking a</span>
<span class="sd">                result dictionary as argument, that can be used to parse the</span>
<span class="sd">                result files and return a list of values.</span>
<span class="sd">            filename (path): name of output .mat file.</span>
<span class="sd">            runs (int): number of runs to gather for each parameter</span>
<span class="sd">                combination.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Make sure all values are lists</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">parameter_space</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameter_space</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">parameter_space</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameter_space</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>

        <span class="c1"># Add a dimension label for each non-singular dimension</span>
        <span class="n">dimension_labels</span> <span class="o">=</span> <span class="p">[{</span><span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">parameter_space</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                                           <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)}</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span>
                            <span class="n">parameter_space</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameter_space</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                            <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[{</span><span class="s1">&#39;runs&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="n">runs</span><span class="p">)}]</span>

        <span class="c1"># Create a list of the parameter names</span>

        <span class="k">return</span> <span class="n">savemat</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span>
            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">get_results_as_numpy_array</span><span class="p">(</span><span class="n">parameter_space</span><span class="p">,</span>
                                             <span class="n">result_parsing_function</span><span class="p">,</span>
                                             <span class="n">runs</span><span class="o">=</span><span class="n">runs</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">object</span><span class="p">),</span>
             <span class="s1">&#39;dimension_labels&#39;</span><span class="p">:</span> <span class="n">dimension_labels</span><span class="p">})</span></div>

<div class="viewcode-block" id="CampaignManager.save_to_npy_file"><a class="viewcode-back" href="../../api.html#sem.CampaignManager.save_to_npy_file">[docs]</a>    <span class="k">def</span> <span class="nf">save_to_npy_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_space</span><span class="p">,</span>
                         <span class="n">result_parsing_function</span><span class="p">,</span>
                         <span class="n">filename</span><span class="p">,</span> <span class="n">runs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save results to a numpy array file format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results_as_numpy_array</span><span class="p">(</span>
            <span class="n">parameter_space</span><span class="p">,</span> <span class="n">result_parsing_function</span><span class="p">,</span> <span class="n">runs</span><span class="o">=</span><span class="n">runs</span><span class="p">))</span></div>

<div class="viewcode-block" id="CampaignManager.save_to_folders"><a class="viewcode-back" href="../../api.html#sem.CampaignManager.save_to_folders">[docs]</a>    <span class="k">def</span> <span class="nf">save_to_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_space</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">runs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save results to a folder structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">space_to_folders</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_results</span><span class="p">(),</span> <span class="p">{},</span> <span class="n">parameter_space</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span>
                              <span class="n">folder_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="CampaignManager.space_to_folders"><a class="viewcode-back" href="../../api.html#sem.CampaignManager.space_to_folders">[docs]</a>    <span class="k">def</span> <span class="nf">space_to_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_result_list</span><span class="p">,</span> <span class="n">current_query</span><span class="p">,</span> <span class="n">param_space</span><span class="p">,</span>
                         <span class="n">runs</span><span class="p">,</span> <span class="n">current_directory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a parameter space specification to a directory tree with a</span>
<span class="sd">        nested structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Base case: we iterate over the runs and copy files in the final</span>
        <span class="c1"># directory.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">param_space</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">run</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_result_list</span><span class="p">[:</span><span class="n">runs</span><span class="p">]):</span>
                <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_result_files</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">new_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_directory</span><span class="p">,</span> <span class="s2">&quot;run=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">run</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">new_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">param_space</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Iterate over dictionary values</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">next_query</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">current_query</span><span class="p">)</span>
            <span class="n">temp_query</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">current_query</span><span class="p">)</span>

            <span class="c1"># For each list, recur &#39;fixing&#39; that dimension.</span>
            <span class="n">next_query</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>  <span class="c1"># Update query</span>

            <span class="c1"># Create folder</span>
            <span class="n">folder_name</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">new_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_directory</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">new_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">next_param_space</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">param_space</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="n">next_param_space</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

            <span class="n">temp_query</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">temp_result_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">current_result_list</span> <span class="k">if</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">satisfies_query</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">temp_query</span><span class="p">)]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">space_to_folders</span><span class="p">(</span><span class="n">temp_result_list</span><span class="p">,</span> <span class="n">next_query</span><span class="p">,</span>
                                  <span class="n">next_param_space</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">new_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="CampaignManager.get_results_as_xarray"><a class="viewcode-back" href="../../api.html#sem.CampaignManager.get_results_as_xarray">[docs]</a>    <span class="k">def</span> <span class="nf">get_results_as_xarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_space</span><span class="p">,</span>
                              <span class="n">result_parsing_function</span><span class="p">,</span>
                              <span class="n">output_labels</span><span class="p">,</span> <span class="n">runs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">extract_complete_results</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the results relative to the desired parameter space in the form</span>
<span class="sd">        of an xarray data structure.</span>

<span class="sd">        Args:</span>
<span class="sd">            parameter_space (dict): The space of parameters to export.</span>
<span class="sd">            result_parsing_function (function): user-defined function, taking a</span>
<span class="sd">                result dictionary as argument, that can be used to parse the</span>
<span class="sd">                result files and return a list of values.</span>
<span class="sd">            output_labels (list): a list of labels to apply to the results</span>
<span class="sd">                dimensions, output by the result_parsing_function.</span>
<span class="sd">            runs (int): the number of runs to export for each parameter</span>
<span class="sd">                combination.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a parameter space only containing the variable parameters</span>
        <span class="n">clean_parameter_space</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parameter_space</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

        <span class="n">clean_parameter_space</span><span class="p">[</span><span class="s1">&#39;runs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_labels</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">clean_parameter_space</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_labels</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_space</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_results</span><span class="p">(),</span> <span class="p">{},</span>
            <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span>
                                     <span class="n">parameter_space</span><span class="o">.</span><span class="n">items</span><span class="p">()]),</span>
            <span class="n">result_parsing_function</span><span class="p">,</span> <span class="n">runs</span><span class="p">)</span>
        <span class="n">xr_array</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">clean_parameter_space</span><span class="p">,</span>
                                <span class="n">dims</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">clean_parameter_space</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="k">return</span> <span class="n">xr_array</span></div>

<div class="viewcode-block" id="CampaignManager.files_in_dictionary"><a class="viewcode-back" href="../../api.html#sem.CampaignManager.files_in_dictionary">[docs]</a>    <span class="k">def</span> <span class="nf">files_in_dictionary</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parsing function that returns a dictionary containing one entry for</span>
<span class="sd">        each file. Typically used to perform parsing externally.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="CampaignManager.get_space"><a class="viewcode-back" href="../../api.html#sem.CampaignManager.get_space">[docs]</a>    <span class="k">def</span> <span class="nf">get_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_result_list</span><span class="p">,</span> <span class="n">current_query</span><span class="p">,</span> <span class="n">param_space</span><span class="p">,</span>
                  <span class="n">result_parsing_function</span><span class="p">,</span>
                  <span class="n">runs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">extract_complete_results</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a parameter space specification to a nested array structure</span>
<span class="sd">        representing the space. In other words, if the parameter space is::</span>

<span class="sd">            param_space = {</span>
<span class="sd">                &#39;a&#39;: [1, 2],</span>
<span class="sd">                &#39;b&#39;: [3, 4]</span>
<span class="sd">            }</span>

<span class="sd">        the function will return a structure like the following::</span>

<span class="sd">            [</span>
<span class="sd">                [</span>
<span class="sd">                    {&#39;a&#39;: 1, &#39;b&#39;: 3},</span>
<span class="sd">                    {&#39;a&#39;: 1, &#39;b&#39;: 4}</span>
<span class="sd">                ],</span>
<span class="sd">                [</span>
<span class="sd">                    {&#39;a&#39;: 2, &#39;b&#39;: 3},</span>
<span class="sd">                    {&#39;a&#39;: 2, &#39;b&#39;: 4}</span>
<span class="sd">                ]</span>
<span class="sd">            ]</span>

<span class="sd">        where the first dimension represents a, and the second dimension</span>
<span class="sd">        represents b. This nested-array structure can then be easily converted</span>
<span class="sd">        to a numpy array via np.array().</span>

<span class="sd">        Args:</span>
<span class="sd">            current_query (dict): the query to apply to the structure.</span>
<span class="sd">            param_space (dict): representation of the parameter space.</span>
<span class="sd">            result_parsing_function (function): user-defined function to call</span>
<span class="sd">                on results, typically used to parse data and outputting</span>
<span class="sd">                metrics.</span>
<span class="sd">            runs (int): the number of runs to query for each parameter</span>
<span class="sd">                combination.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">result_parsing_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result_parsing_function</span> <span class="o">=</span> <span class="n">CampaignManager</span><span class="o">.</span><span class="n">files_in_dictionary</span>
            <span class="c1"># Note that this function operates recursively.</span>

        <span class="c1"># Base case</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">param_space</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">current_result_list</span> <span class="k">if</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">satisfies_query</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">current_query</span><span class="p">)]</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[:</span><span class="n">runs</span><span class="p">]:</span>

                <span class="c1"># Make results complete, by reading the output from file</span>
                <span class="c1"># TODO Extract this into a function</span>
                <span class="n">r</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">available_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_result_files</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">available_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">extract_complete_results</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_contents</span><span class="p">:</span>
                            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_contents</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">r</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">filepath</span>
                <span class="n">parsed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_parsing_function</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">r</span>
            <span class="k">del</span> <span class="n">results</span>

            <span class="k">return</span> <span class="n">parsed</span>

        <span class="n">space</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">param_space</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="c1"># Iterate over dictionary values</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">next_query</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">current_query</span><span class="p">)</span>
            <span class="n">temp_query</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">current_query</span><span class="p">)</span>
            <span class="c1"># For each list, recur &#39;fixing&#39; that dimension.</span>
            <span class="n">next_query</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">next_param_space</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">param_space</span><span class="p">)</span>
            <span class="k">del</span><span class="p">(</span><span class="n">next_param_space</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">temp_query</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">temp_result_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">current_result_list</span> <span class="k">if</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">satisfies_query</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">temp_query</span><span class="p">)]</span>
            <span class="n">space</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_space</span><span class="p">(</span><span class="n">temp_result_list</span><span class="p">,</span> <span class="n">next_query</span><span class="p">,</span>
                                        <span class="n">next_param_space</span><span class="p">,</span>
                                        <span class="n">result_parsing_function</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span>
                                        <span class="n">extract_complete_results</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">space</span></div>

    <span class="k">def</span> <span class="nf">satisfies_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">current_param</span><span class="p">,</span> <span class="n">current_value</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="n">current_param</span><span class="p">]</span> <span class="o">!=</span> <span class="n">current_value</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1">#############</span>
    <span class="c1"># Utilities #</span>
    <span class="c1">#############</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a human-readable representation of the campaign.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">:</span>
            <span class="c1"># if the campaign has a runner, print the db and the type of runner</span>
            <span class="k">return</span> <span class="s2">&quot;--- Campaign info ---</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">Runner type: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">-----------&quot;</span> <span class="o">%</span>\
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># the campaign has no runner, print only the db</span>
            <span class="k">return</span> <span class="s2">&quot;--- Campaign info ---</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">-----------&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>

<div class="viewcode-block" id="CampaignManager.check_repo_ok"><a class="viewcode-back" href="../../api.html#sem.CampaignManager.check_repo_ok">[docs]</a>    <span class="k">def</span> <span class="nf">check_repo_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure that the ns-3 repository&#39;s HEAD commit is the same as the one</span>
<span class="sd">        saved in the campaign database, and that the ns-3 repository is clean</span>
<span class="sd">        (i.e., no untracked or modified files exist).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">git</span> <span class="kn">import</span> <span class="n">Repo</span><span class="p">,</span> <span class="n">exc</span>
        <span class="c1"># Check that git is at the expected commit and that the repo is not</span>
        <span class="c1"># dirty</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">path</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">repo</span> <span class="o">=</span> <span class="n">Repo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">InvalidGitRepositoryError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No git repository detected.</span><span class="se">\n</span><span class="s2">In order to &quot;</span>
                                <span class="s2">&quot;use SEM and its reproducibility enforcing &quot;</span>
                                <span class="s2">&quot;features, please create a git repository at &quot;</span>
                                <span class="s2">&quot;the root of your ns-3 project.&quot;</span><span class="p">)</span>
            <span class="n">current_commit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">hexsha</span>
            <span class="n">campaign_commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_commit</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">repo</span><span class="o">.</span><span class="n">is_dirty</span><span class="p">(</span><span class="n">untracked_files</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ns-3 repository is not clean&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">current_commit</span> <span class="o">!=</span> <span class="n">campaign_commit</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ns-3 repository is on a different commit &quot;</span>
                                <span class="s2">&quot;from the one specified in the campaign&quot;</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3><a href="../../index.html">Home</a></h3><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Davide Magrin.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>